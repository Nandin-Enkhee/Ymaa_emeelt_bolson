<!DOCTYPE html>
<html lang="mn">
<head>
<meta charset="UTF-8">
<title>Ямааны бүртгэл</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { 
  font-family: "Segoe UI", sans-serif; 
  background-color: #f8fafc; 
  padding: 20px; 
  margin: 0; 
  color: #1e293b;
}
.container { 
  max-width: 720px; 
  margin: auto; 
  background: #fff; 
  padding: 24px; 
  border-radius: 16px; 
  border: 1px solid #e2e8f0; 
  box-shadow: 0 4px 10px rgba(0,0,0,0.05);
}
h2, h3 {
  text-align:center;
  color:#6f4e37;
}
input, button {
  width:100%;
  padding:12px;
  margin:10px 0;
  border-radius:8px;
  border:1px solid #e2e8f0;
  font-size:16px;
  box-sizing:border-box;
}
button {
  background-color:#6f4e37;
  color:white;
  font-weight:bold;
  cursor:pointer;
  transition: background-color 0.3s;
}
button:hover {
  background-color:#5a3e2b;
}
.receipt {
  border:1px solid #e2e8f0;
  padding:16px;
  margin:20px 0;
  border-radius:8px;
}
.sign-area {
  margin-top:40px;
  display:flex;
  justify-content:space-between;
}
.sign-box {
  width:45%;
  text-align:center;
  border-top:1px solid #000;
  padding-top:8px;
}
.batch-container {
  margin: 15px 0;
  padding: 10px;
  border: 1px dashed #e2e8f0;
  border-radius: 8px;
}
.print-buttons {
  display: flex;
  gap: 10px;
}
.print-buttons button {
  flex: 1;
}
#resultArea {
  margin-top: 30px;
}
.loading {
  display: none;
  text-align: center;
  padding: 20px;
}
.loading.spinner {
  border: 4px solid #f3f3f3;
  border-top: 4px solid #6f4e37;
  border-radius: 50%;
  width: 30px;
  height: 30px;
  animation: spin 1s linear infinite;
  margin: 0 auto;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
@media print {
  input, button, h2, h3, .no-print {
    display: none !important;
  }
  body {
    font-size: 18px;  /* Томруулсан */
    line-height: 1.5; /* Мөр хоорондын зай нэмэгдүүлнэ */
    background:white;
    margin:0;
  }
  
  .container {
    padding:0;
    box-shadow:none;
    border:none;
    max-width:100%;
  }
  .receipt {
    font-size: 18px;
    border:none;
    page-break-inside:avoid;
    margin:0;
  }
  .batch-container,
  .batch-container h4 {
    display: none !important;
  }
  @page {
    margin:10mm;
  }
  .page-break {
    page-break-after: always;
  }
}
</style>
</head>
<body>
<div class="container" id="mainForm">
  <h2>Ямааны бүртгэлийн систем</h2>

  <input type="date" id="date">
  <input type="text" id="herder" placeholder="Малчны нэр">
  <input type="text" id="account" placeholder="Дансны дугаар">
  <input type="text" id="phone" placeholder="Утасны дугаар">

  <input type="number" id="goatCount" placeholder="Нийт ямааны тоо">
  <input type="number" id="batchSize" placeholder="Багцын хэмжээ (жишээ нь: 5)">
  <button onclick="generateBatchFields()">Багцын талбар үүсгэх</button>

  <div id="batchFields"></div>

  <h3>Үнэ бодох тохиргоо</h3>
  <input type="number" id="avgLimit" placeholder="Дундаж жингийн босго (жишээ: 17)">
  <input type="number" id="priceAbove" placeholder="Босгоос дээш ₮">
  <input type="number" id="priceBelow" placeholder="Босгоос доош ₮">
  <input type="number" id="slaughterFee" placeholder="1 ямааны бойны хөлс (₮)">

  <div class="print-buttons">
    <button id="calculateBtn" onclick="generateReceipt()">Бодох & Илгээх</button>
    <button onclick="window.print()">Хэвлэх</button>
    <button onclick="resetForm()">Цэвэрлэх</button>
  </div>
</div>

<div class="loading" id="loading">
  <div class="spinner"></div>
  <p>Мэдээлэл илгээж байна...</p>
</div>

<div id="resultArea"></div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("date").value = new Date().toISOString().split("T")[0];
});

function generateBatchFields() {
  const goatCount = parseInt(document.getElementById("goatCount").value);
  const batchSize = parseInt(document.getElementById("batchSize").value);
  const container = document.getElementById("batchFields");
  container.innerHTML = "";

  if (isNaN(goatCount) || isNaN(batchSize) || goatCount <= 0 || batchSize <= 0) {
    alert("Зөв тоо оруулна уу!");
    return;
  }

  let fullBatches = Math.floor(goatCount / batchSize);
  let remainder = goatCount % batchSize;
  let totalBatches = fullBatches + (remainder > 0 ? 1 : 0);

  for (let i = 0; i < totalBatches; i++) {
    const batchDiv = document.createElement("div");
    batchDiv.className = "batch-container";
    let count = (i < fullBatches) ? batchSize : remainder;
    batchDiv.innerHTML = `
      <h4>${i+1}-р багц (${count} ямаа)</h4>
      <input type="number" class="batchWeight" placeholder="Нийт жин (кг)">
      <input type="hidden" class="batchCount" value="${count}">
    `;
    container.appendChild(batchDiv);
  }
}

async function sendToSheet(data) {
  try {
    // Google Apps Script Web App URL - энд өөрийн URL-ээ оруулна уу
    const scriptURL = 'https://script.google.com/macros/s/AKfycby5wP-NbdmIoq74LAtfjPkXDWd5a7QmcyNpzlVpP1S1TXVbqKtTr4R_Xr4pZZOIFEMZlg/exec';
    
    document.getElementById('loading').style.display = 'block';
    
    const response = await fetch(scriptURL, {
      method: 'POST',
      headers: {
        'Content-Type': 'text/plain;charset=utf-8',
      },
      body: JSON.stringify(data)
    });
    
    const result = await response.json();
    document.getElementById('loading').style.display = 'none';
    
    if (result.status === 'success') {
      alert("Мэдээлэл амжилттай Google Sheets рүү хадгалагдлаа!");
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    document.getElementById('loading').style.display = 'none';
    console.error('Алдаа:', error);
    alert("Алдаа гарлаа: " + error.message);
  }
}

function generateReceipt() {
  const date = document.getElementById("date").value;
  const herder = document.getElementById("herder").value;
  const account = document.getElementById("account").value;
  const phone = document.getElementById("phone").value;

  const counts = Array.from(document.getElementsByClassName("batchCount")).map(el => parseInt(el.value));
  const weights = Array.from(document.getElementsByClassName("batchWeight")).map(el => parseFloat(el.value));

  // Баталгаажуулалт
  if (!date || !herder || !account || !phone) {
    alert("Бүх мэдээллийг оруулна уу!");
    return;
  }

  if (weights.some(w => isNaN(w) || w <= 0)) {
    alert("Бүх багцын жинг зөв оруулна уу!");
    return;
  }

  let totalGoats = 0, totalWeight = 0, details = "";
  counts.forEach((c, i) => {
    const w = weights[i] || 0;
    totalGoats += c;
    totalWeight += w;
    const avg = (w / c).toFixed(2);
    details += `${i+1}-р багц: ${c} ямаа, нийт жин ${w} кг, дундаж = ${avg} кг\n`;
  });

  const avgTotal = (totalWeight / totalGoats).toFixed(2);
  const limit = parseFloat(document.getElementById("avgLimit").value) || 17;
  const priceAbove = parseFloat(document.getElementById("priceAbove").value) || 0;
  const priceBelow = parseFloat(document.getElementById("priceBelow").value) || 0;
  const price = (avgTotal >= limit) ? priceAbove : priceBelow;
  const totalSum = totalWeight * price;
  const slaughterPerHead = parseFloat(document.getElementById("slaughterFee").value) || 0;
  const slaughterFee = totalGoats * slaughterPerHead;
  const finalSum = totalSum - slaughterFee;

  // Google Sheets рүү илгээх мэдээлэл
  const sheetData = {
    date: date,
    herder: herder,
    account: account,
    phone: phone,
    totalGoats: totalGoats,
    totalWeight: totalWeight,
    avgWeight: avgTotal,
    price: price,
    totalSum: totalSum,
    slaughterFee: slaughterFee,
    finalSum: finalSum,
    details: details
  };

  // Receipt үүсгэх
  let receipts="";
  ["Малчинд олгох хувь","Компанид үлдэх хувь"].forEach(copy=>{
    receipts+=`
      <div class="receipt">
        <h2><strong>ЭМЭЭЛТ ЭРДЭНЭ ТРЕЙД ХХК</strong></h2>
        <p style="text-align:center;">
            <strong>ЭМЭЭЛТ ЭРДЭНЭ ТРЕЙД ХХК</strong><br>
            <strong>Холбогдох утас:</strong> 94020230, 89028230<br>
            <strong>Facebook Page:</strong> Эмээлт Эрдэнэ Трейд ХХК
        <p><strong>${copy}</strong></p>
        <p><strong>Огноо:</strong> ${date}</p>
        <p><strong>Малчны нэр:</strong> ${herder}</p>
        <p><strong>Дансны дугаар:</strong> ${account}</p>
        <p><strong>Утас:</strong> ${phone}</p>
        <pre><strong>${details}</pre></strong>
        <p><strong>Нийт ямааны тоо:</strong> ${totalGoats}</p>
        <p><strong>Нийт жин:</strong> ${totalWeight} кг</p>
        <p><strong>Дундаж жин:</strong> ${avgTotal} кг × ${price.toLocaleString()} ₮ = ${totalSum.toLocaleString()} ₮</p>
        <p><strong>Бойны хөлс:</strong> ${totalGoats} × ${slaughterPerHead.toLocaleString()} ₮ = -${slaughterFee.toLocaleString()} ₮</p>
        <p>Нийт дүн: ${totalSum.toLocaleString()} ₮ - ${slaughterFee.toLocaleString()} ₮ = ${finalSum.toLocaleString()} ₮</p>
        <p>Малчны гарын үсэг: _________________________________</p>
        <p>Хүлээн авсан: Эмээлт Эрдэнэ Трейд ХХК</p>
      </div>
    `;
  });

  document.getElementById("resultArea").innerHTML = receipts;
  
  // Google Sheets рүү илгээх
  sendToSheet(sheetData);
}

function resetForm() { 
  if (confirm("Формыг цэвэрлэх үү?")) {
    location.reload(); 
  }
}
</script>
</body>
</html>